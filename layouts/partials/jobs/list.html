{{/*
Lists jobs from data/jobs. Splits into open and archived by expires date.
Sorts open by deadline asc; archived by expires desc.
*/}}
{{- $now := now -}}
{{- $jobs := slice -}}

{{/* Only load YAML job postings from data/jobs */}}
{{- range $key, $data := .Site.Data.jobs -}}
  {{- if and (ne $key "schema") (ne $key "_TEMPLATE") -}}
    {{- $job := (dict "key" $key) | merge $data -}}
    {{- $jobs = $jobs | append $job -}}
  {{- end -}}
{{- end -}}

{{/* Fallback: if no jobs loaded via .Site.Data, read YAML files directly */}}
{{- if eq (len $jobs) 0 -}}
  {{- range (readDir "data/jobs") -}}
    {{- if and (not .IsDir) (or (hasSuffix .Name ".yaml") (hasSuffix .Name ".yml")) (ne .Name "_TEMPLATE.yaml") (ne .Name "schema.json") -}}
      {{- $path := printf "data/jobs/%s" .Name -}}
      {{- $data := (readFile $path | transform.Unmarshal) -}}
      {{- $key := replaceRE "\\.(yaml|yml)$" "" .Name -}}
      {{- $job := (dict "key" $key) | merge $data -}}
      {{- $jobs = $jobs | append $job -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* partition */}}
{{- $open := slice -}}
{{- $archived := slice -}}
{{- range $jobs -}}
  {{- $exp := .expires -}}
  {{- if or (not $exp) (ge (time $exp) $now) -}}
    {{- $open = $open | append . -}}
  {{- else -}}
    {{- $archived = $archived | append . -}}
  {{- end -}}
{{- end -}}

{{- $sortedOpen := sort $open "deadline" "asc" -}}

<h2 id="open-roles">Open roles</h2>
{{- if gt (len $sortedOpen) 0 -}}
  {{- range $sortedOpen -}}
    {{ partial "jobs/card.html" (dict "job" . "now" $now) }}
  {{- end -}}
{{- else -}}
  <p>No open roles at the moment.</p>
{{- end -}}

<hr/>

{{- $sortedArchived := sort $archived "expires" "desc" -}}
{{- $body := "" -}}
{{- if gt (len $sortedArchived) 0 -}}
  {{- $scratch := newScratch -}}
  {{- range $sortedArchived -}}
    {{- $scratch.Add "html" (partial "jobs/card.html" (dict "job" . "now" $now)) -}}
  {{- end -}}
  {{- $body = $scratch.Get "html" -}}
{{- else -}}
  {{- $body = "<p>No archived roles yet.</p>" -}}
{{- end -}}
{{- $md := printf "{{< details \"%s\" >}}\n%s\n{{< /details >}}" "Archived roles" $body -}}
{{ .Page.RenderString $md }}
